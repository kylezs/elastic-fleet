apiVersion: v1
kind: ConfigMap
metadata:
  name: filebeat-config
data:
  filebeat.yml: |
    filebeat.inputs:
    - type: log
      paths:
        - {{ .Values.fleet.filesystem.result_volume }}/result.log
      json.keys_under_root: true
      processors:
        - if:
            has_fields: ['decorations.downloaded_name']
          then:
            - dissect:
                tokenizer: "%{base64email}-launcher.%{restofpackagename}"
                field: "decorations.downloaded_name"
                target_prefix: ""
            - decode_base64_field:
                field:
                  from: "base64email"
                  to: "email"
                ignore_missing: true
                fail_on_error: false
        - if:
            has_fields: ['decorations.service_name']
          then:
            - dissect:
                tokenizer: "Launcher%{base64emailWin}Svc"
                field: "decorations.service_name"
                target_prefix: ""
            - script:
                lang: javascript
                id: correctb64padding
                source: >
                  function process(event) {
                    var base64emailWithDummy = event.Get('base64emailWin')
                    var base64email = base64emailWithDummy.slice(1)
                    var lenB64email = base64email.length;
                    var paddingLen = (4 - (lenB64email % 4)) % 4
                    var i;
                    for (i = 0; i < paddingLen; i++) {
                      base64email = base64email + "=";
                    }
                    event.Put('base64emailWinAfter', base64email)
                  }
            - decode_base64_field:
                field:
                  from: "base64emailWinAfter"
                  to: "email"
                ignore_missing: true
                fail_on_error: false
        - drop_fields:
            fields: ["log.file.path", "numerics", "epoch", "ecs.version", "counter",
              "action", "suricata.eve.timestamp", "input.type",
              "agent.ephemeral_id", "agent.hostname", "agent.id", "agent.version", "host.name",
              "log.offset", "unixTime", "restofpackagename", "decorations.downloaded_name",
              "deocorations.service_name", "base64email", "base64emailWin", "base64emailWinAfter"]
    output.elasticsearch:
      host: '${NODE_NAME}'
      hosts: 'http://elasticsearch-master:9200'
      protocol: http
      username: '${ELASTICSEARCH_USERNAME}'
      password: '${ELASTICSEARCH_PASSWORD}'
---

